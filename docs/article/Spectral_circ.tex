\documentclass[a4paper]{article}   	% use "amsart" instead of "article" for AMSLaTeX format

\usepackage{geometry}               	
\geometry{a4paper,margin=1.1in}           % ... or a4paper or a5paper or ... 

%\usepackage{graphicx}			

\usepackage{amsmath}
\usepackage{tikz}

\usepackage{hyperref}
\hypersetup{colorlinks=true,
    citecolor=blue,    filecolor=blue,
    linkcolor=blue,     urlcolor=blue
}
%\usepackage{cite}
\usepackage{natbib}

\newcommand{\ir}{\frac{1}{r}}
\newcommand{\Integ}[1]{\int_{-\infty}^{\infty} \!\!\!\!\!\!\!\!
  \mathrm{d}#1}
\newcommand{\RInteg}[1]{\int_{0}^{\infty} \!\!\!\!\!\!\! #1\mathrm{d}#1}
\newcommand{\rInteg}{\int_{0}^{r_{max}} \!\!\!\!\!\!\! r\mathrm{d}r}
\newcommand{\TInteg}[1]{\int_{0}^{2\pi} \!\!\!\!\!\!\!\! \mathrm{d}#1}

\newcommand{\tB}[2]{\tilde{B}_{#1,m}^{#2}}
\newcommand{\tE}[2]{\tilde{E}_{#1,m}^{#2}}
\newcommand{\tj}[2]{\tilde{j}_{#1,m}^{#2}}

\newcommand{\trho}[1]{\tilde{\rho}_{m}^{#1}}

\renewcommand{\vec}[1]{\boldsymbol{#1}}

\newcommand{\spectral}[1]{\hat{\mathcal{#1}}}

% Reference automatique aux equations, sections, figures
\usepackage{cleveref}

\title{A pseudo-spectral, cylindrical and dispersion-free Particle-In-Cell algorithm}
%\pagestyle{empty}
\author{R\'emi \textsc{Lehe}, Jean-Luc \textsc{Vay}}

\begin{document}

\maketitle


\section*{Introduction}

% Introduce finite difference.
%Comment that these equations are similar to the ones in Cartesian spectral

Particle-In-Cell (PIC) algorithms\citep{Birdsall2004,Hockney1988} 
are extensively used in several areas of physics, including the study
of astrophysical plasmas and usion plasmas,
as well as for laser-plasma interactions and accelerator physics. Yet,
despite their wide use, PIC algorithms remain very computationally
demanding and are still subject to a range of numerical artifacts. 
These shortcomings can be particularly significant for
simulations of accelerated particle beams and of 
laser-plasma interactions (such as laser-wakefield acceleration). 
This is mainly for two reasons:
\begin{itemize}
\item In these cases, the system often has close-to-cylindrical
  symmetry (e.g. particle beams and laser pulses are often
  cylindrically symmetric). This prevents the use of 2D Cartesian 
PIC algorithms (which are only well-suited for slab-like symmetry),
and is instead often dealt with by using
  3D Cartesian PIC algorithms. However, 3D PIC algorithms are extremely
  computationally intensive.
\item The physical objects of interest (e.g. the laser, or the
  accelerated particle beam) often propagate close to the speed of
  light. This makes them very sensitive to \emph{numerical
    dispersion}, i.e. the fact that the electromagnetic waves do not
  propagate exactly at the physical speed of light in a standard PIC
  code, but propagate instead at an spuriously-altered,
  resolution-dependent speed. In the above-mentioned cases, 
numerical dispersion can lead to substantial numerical artifacts
which can mask or disrupt the physics at stake in the simulation. This
includes for instance numerical Cherenkov effect in general
\citep{GodfreyJCP1974}, but also more specific artifacts, such as
e.g. the erroneous prediction of the dephasing length in
laser-wakefield acceleration \citep{CowanPRSTAB2013}.

\end{itemize}
Yet several improvements can be made to the PIC algorithm, in order
to mitigate these difficulties and increase the speed and
accuracy of PIC algorithms in these situations. 
\begin{itemize}
\item One of these improvements was introduced by the recent
  development of cylindrically-symmetric
PIC algorithms with azimuthal decomposition \citep{Lifschitz,Davidson} (also
refered to as \emph{quasi-3D} algorithms). By taking
into account the symmetry of the system, these algorithms can typically reduce
the cost of the simulation to a few times that of a 2D Cartesian simulation,
instead of that of a full 3D Cartesian simulation. Moreover, unlike 2D
Cartesian algorithms, these algorithms are well adapted to close-to-cylindrical
physical systems and can accurately capture physical effects that are intrisically
3D (such as e.g. the non-linear self-focusing of an intense laser in a
plasma \citep{EsareyRMP2009}).

\item A second, separate improvement was introduced by spectral
Cartesian PIC algorithms \citep{BunemanJCP1980,DawsonRMP1983},
i.e. algorithms that solve the Maxwell equations in Fourier
space. There is indeed a class of spectral algorithms -- often refered to
as \emph{Pseudo-Spectral Analytical Time Domain} (PSATD) algorithms 
\citep{Haber} -- which exhibits no numerical dispersion whatsoever. As a
consequence, these algorithms are free from the numerical artifacts
associated with the spurious speed of the electromagnetic waves in PIC
codes. Moreover, it was shown recently
\citep{XuJCP2013,YuJCP2014,YuCPC2015,
GodfreyIEEE2014,GodfreyJCP2014} 
that spectral PIC algorithms have better stability properties when 
performing PIC simulations in
a Lorentz-boosted frame \citep{VayPRL2007,MartinsNatPhys2010}. 
These stability properties are very
promising since boosted-frame simulations can be faster than 
their laboratory-frame counterparts by several orders of magnitude \citep{VayPRL2007}.
\end{itemize}

Even though these two improvements are both very valuable, they cannot be
combined with one another in their present
formulation. This is because the \emph{quasi-3D} algorithm uses a
cylindrical system of coordinates, whereas the spectral PIC algorithms
(and in particular the \emph{PSTAD} algorithms)
were developped in a Cartesian system of coordinates. This
incompatibility is however not definitive, and the aim of this article
is to overcome these differences by developping a \emph{spectral
  cylindrical} formalism. In this document, we derive this formalism,
and we show that it can be used to build a PIC algorithm that combines 
the speed of \emph{quasi-3D} algorithms with
the accuracy and lack of numerical dispersion of the \emph{PSATD} algorithms.

Although the algorithm described here is, to our knowledge, unique in
its capabilities, there are several other PIC algorithms that use 
a similar -- yet not equivalent -- approach. One such example is the
hybrid, cylindrical version of \textsc{OSIRIS} \citep{Yuarxiv2015}. This algorithm
involves a Fourier transform in the longitudinal direction, but
retains a finite-difference formulation in the transverse (radial)
direction. As a consequence, this algorithm is not fully spectral, nor
fully dispersion-free. Another such example is the PIC code \textsc{PlaRes} 
\citep{AndriyashJCP2015}, which also uses a spectral cylindrical
formalism but relies on the scalar and vector potentials
$\phi$ and $\vec{A}$ instead of the standard PIC formulation in terms
of $\vec{E}$ and $\vec{B}$. As a result, \textsc{PlaRes} largely differs from the
algorithm described here, both in the equations that it simulates and
in their numerical implementation.

In the present article, we start by deriving the equations of our
spectral cylindrical formalism (\cref{sec:theory}). We then explain
how these equations were discretized and implemented in a fully
working PIC code (\cref{sec:implementation}). We then report on the
results of a number of benchmarks that were performed with this PIC
code (\cref{sec:benchmarks}), and describe two typical physical situations in
which our spectral algorithm performs better than standard,
finite-difference algorithms (\cref{sec:advantages}).

\section{Representation of the fields and continuous equations}
\label{sec:theory}

\subsection{A reminder on Cartesian spectral codes}

It is well-known that the Maxwell equations in Cartesian coordinates 
\begin{align}
\frac{1}{c^2}\partial_t E_x = \partial_y B_z - \partial_z B_y - \mu_0  j_x \qquad&   
\partial_t B_x = -\partial_y E_z + \partial_z E_y \label{eq:CartMaxwellx} \\
\frac{1}{c^2}\partial_t E_y = \partial_z B_x - \partial_x B_z - \mu_0  j_y \qquad &   
\partial_t B_y = -\partial_z E_x + \partial_x E_z \label{eq:CartMaxwelly}  \\
\frac{1}{c^2}\partial_t E_z = \partial_x B_y - \partial_y B_x - \mu_0  j_z \qquad &   
\partial_t B_z = -\partial_x E_y + \partial_y E_x \label{eq:CartMaxwellz} 
\end{align}
can be solved by representing the fields as a sum of Fourier modes.
\begin{equation}
\label{eq:CartBwTrans}
F_u(\vec{r}) = \frac{1}{(2\pi)^{3}}\Integ{k_x} \,\Integ{k_y}\,
\Integ{k_z} \; \mathcal{F}_u(\vec{k}) \, e^{i(k_x x + k_y y + k_z z)} 
\end{equation}
with 
\begin{equation}
\label{eq:CartFwTrans}
\mathcal{F}_u(\vec{k})  = \Integ{x} \,\Integ{y}\, \Integ{z} \;
F_u(\vec{r}) \, e^{-i(k_x x + k_y y + k_z z)} 
\end{equation}
where $F$ is any of the fields $E$, $B$ or $j$, and where $u$ is
either $x$, $y$ or $z$. $\mathcal{F}$ represents the Fourier
components of $F$, which will be denoted
$\mathcal{E}$, $\mathcal{B}$ or $\mathcal{J}$ depending on whether
$F$ represents $E$, $B$ or $j$. With this representation, the
different Fourier modes decouple and the equations 
\cref{eq:CartMaxwellx,eq:CartMaxwelly,eq:CartMaxwellz} become 
\begin{align}
\frac{1}{c^2}\partial_t \mathcal{E}_x = ik_y \mathcal{B}_z - ik_z \mathcal{B}_y - \mu_0 \mathcal{J}_x \qquad &   
\partial_t \mathcal{B}_x = -ik_y \mathcal{E}_z + ik_z \mathcal{E}_y \\
\frac{1}{c^2}\partial_t \mathcal{E}_y = ik_z \mathcal{B}_x - ik_x \mathcal{B}_z - \mu_0  \mathcal{J}_y \qquad &   
\partial_t \mathcal{B}_y = -ik_z \mathcal{E}_x + ik_x \mathcal{E}_z \\
\frac{1}{c^2}\partial_t \mathcal{E}_z = ik_x \mathcal{B}_y - ik_y \mathcal{B}_x - \mu_0 \mathcal{J}_z  \qquad &   
\partial_t \mathcal{B}_z = -ik_x \mathcal{E}_y + ik_y \mathcal{E}_x 
\end{align}
The Fourier coefficients can then be integrated in time, and
transformed back into real space using \cref{eq:CartBwTrans}. This is
the core principle of Cartesian pseudo-spectral time-domain (PSTD)
algorithms and pseudo-spectral analytical time-domain (PSATD) algorithms.

\subsection{Spectral cylindrical decomposition}

The Fourier representation \cref{eq:CartBwTrans} is no longer the
appropriate representation when the Maxwell equations are written in cylindrical coordinates.
\begin{align}
\frac{1}{c^2}\partial_t E_r = \ir \partial_\theta B_z - \partial_z B_\theta - \mu_0  j_r \qquad&   
\partial_t B_r = -\ir \partial_\theta E_z + \partial_z E_\theta \label{eq:CircMaxwellr} \\
\frac{1}{c^2}\partial_t E_\theta = \partial_z B_r - \partial_r B_z - \mu_0  j_\theta \qquad &   
\partial_t B_\theta = -\partial_z E_r + \partial_r E_z \label{eq:CircMaxwellt}  \\
\frac{1}{c^2}\partial_t E_z = \ir\partial_r r B_\theta - \ir\partial_\theta B_r - \mu_0  j_z \qquad & 
\partial_t B_z = -\ir\partial_r r E_\theta + \ir\partial_\theta E_r \label{eq:CircMaxwellzz} 
\end{align}
When replacing
\cref{eq:CartBwTrans} into the \cref{eq:CircMaxwellr,eq:CircMaxwellt,eq:CircMaxwellzz}, the Fourier modes do not decouple. Instead one has to use the Fourier-Bessel representation.
\begin{align}
& F_z(\vec{r}) = \frac{1}{(2\pi)^2}\!\!\!\sum_{m=-\infty}^{\infty} \Integ{k_z}
\RInteg{k_\perp }\; \spectral{F}_{z,m}(k_z,k_\perp ) \; J_m(k_\perp r)\, e^{-im\theta + ik_z z} 
\label{eq:CircBwTransz} \\
& F_r(\vec{r}) = \frac{1}{(2\pi)^2}\!\!\!\sum_{m=-\infty}^{\infty} \Integ{k_z}\,\RInteg{k_\perp }\;
\left( \spectral{F}_{+,m}(k_z,k_\perp )\; J_{m+1}(k_\perp r) +\spectral{F}_{-,m}(k_z,k_\perp )\; J_{m-1}(k_\perp r)
\right)  e^{-im\theta +ik_z z}
\label{eq:CircBwTransr} \\
& F_\theta(\vec{r}) = \frac{1}{(2\pi)^2}\!\!\!\sum_{m=-\infty}^{\infty} \Integ{k_z}\,\RInteg{k_\perp }\;
i\left( \spectral{F}_{+,m}(k_z,k_\perp )\; J_{m+1}(k_\perp r) - \spectral{F}_{-,m}(k_z,k_\perp )\; J_{m-1}(k_\perp r)
\right)  e^{-im\theta +ik_z z} 
\label{eq:CircBwTranst}
\end{align}
where $F$ is either $E$, $B$ or $j$. Notice that the Cartesian
component $F_z$ and cylindrical components
$F_r$, $F_\theta$ do not transform in the same manner, which is due
to their different behavior close to the axis. (See
\cref{sec:CircTrans} for a derivation of this representation and for
its relation to the Fourier transform.) In addition, the coefficients $\spectral{F}_z$, $\spectral{F}_+$ and
 $\spectral{F}_{-}$ are given by:
\begin{align}
\spectral{F}_{z,m}(k_z,k_\perp ) &= \Integ{z} \RInteg{r}
\TInteg{\theta} \;F_z(\vec{r})\; J_m(k_\perp r) e^{im\theta
 - i k_z z} \label{eq:CircFwTransz} \\
\spectral{F}_{+,m}(k_z,k_\perp ) &= \Integ{z} \RInteg{r}
\TInteg{\theta} \;\frac{F_r (\vec{r})-iF_\theta (\vec{r})}{2}\; J_{m+1}(k_\perp r) e^{im\theta
 - i k_z z} \label{eq:CircFwTransp} \\
\spectral{F}_{-,m}(k_z,k_\perp ) &= \Integ{z} \RInteg{r}
\TInteg{\theta} \;\frac{F_r (\vec{r})+iF_\theta(\vec{r})}{2}\; J_{m-1}(k_\perp r) e^{im\theta
 - i k_z z} \label{eq:CircFwTransm} 
\end{align}
\noindent Note also that scalar fields (like $\rho$) transform in the same way as the Cartesian component $F_z$.

When replacing \cref{eq:CircBwTransr,eq:CircBwTranst,eq:CircBwTransz} into the Maxwell equations in cylindrical
coordinates \cref{eq:CircMaxwellr,eq:CircMaxwellt,eq:CircMaxwellzz},
the different modes decouple, and the equations for the spectral
coefficients become:
\begin{align}
\frac{1}{c^2}\partial_t \spectral{E}_{+,m} = - \frac{ik_\perp }{2}\spectral{B}_{z,m} + k_z\spectral{B}_{+,m} - \mu_0\spectral{J}_{+,m} \qquad &   
\partial_t \spectral{B}_{+,m} = \frac{ik_\perp }{2} \spectral{E}_{z,m} - k_z
\spectral{E}_{+,m} 
\label{eq:CircMaxwellp} \\
\frac{1}{c^2}\partial_t \spectral{E}_{-,m} = -\frac{ik_\perp }{2} \spectral{B}_{z,m} - k_z \spectral{B}_{-,m} - \mu_0  \spectral{J}_{-,m} \qquad &   
\partial_t \spectral{B}_{-,m} = \frac{ik_\perp }{2} \spectral{E}_{z,m} + k_z
\spectral{E}_{-,m} \label{eq:CircMaxwellm} \\
\frac{1}{c^2}\partial_t \spectral{E}_{z,m} = ik_\perp  \spectral{B}_{+,m} + ik_\perp \spectral{B}_{-,m}  - \mu_0 \spectral{J}_{z,m}  \qquad & 
\partial_t \spectral{B}_{z,m} = -ik_\perp  \spectral{E}_{+,m} - ik_\perp \spectral{E}_{-,m}  \label{eq:CircMaxwellz} 
\end{align}
(See \cref{sec:SpectMaxwell} for a derivation of these equations.) In
addition, the conservation equations
$\vec{\nabla}\cdot\vec{E}=\rho/\epsilon_0$ and
$\vec{\nabla}\cdot\vec{B} = 0$
become
\begin{equation}
\label{eq:SpectCons}
k_\perp (\spectral{E}_{+,m} -\spectral{E}_{-,m}) + ik_z \spectral{E}_{z,m} =
\frac{\spectral{\rho}_m}{\epsilon_0} \qquad
 k_\perp (\spectral{B}_{+,m} -\spectral{B}_{-,m}) + ik_z \spectral{B}_{z,m} =
0 \end{equation}
As expected, the above conservation equations are
preserved by the Maxwell equations
\cref{eq:CircMaxwellp,eq:CircMaxwellm,eq:CircMaxwellz}, provided
that the current satisfies $\partial_t
\rho + \vec{\nabla} \cdot \vec{j} = 0$, i.e. in spectral space:
\begin{equation}
\label{eq:SpectCharge}
\partial_t \spectral{\rho}_m + k_\perp (\spectral{J}_{+,m} -\spectral{J}_{-,m}) + ik_z
\spectral{J}_{z,m} = 0
\end{equation}  

Again, the equations \cref{eq:CircMaxwellp,eq:CircMaxwellm,eq:CircMaxwellz}  can be
integrated in time, and the fields can then be transformed back into
real space, using \cref{eq:CircBwTransz,eq:CircBwTransr,eq:CircBwTranst}. Notice that
the structure of \cref{eq:CircMaxwellp,eq:CircMaxwellm,eq:CircMaxwellz} is similar to
the structure of the corresponding equations in a Cartesian PIC code. Therefore,
the methods used to integrate the fields in time in a Cartesian
spectral code (e.g. PSATD) should be transposable to the cylindrical case.

Typically one needs only a few modes in $m$, therefore the fields are
reduced to a few 2D tables $\spectral{F}_m(k_z,k_\perp )$ instead of the
3D tables $\hat{F}(k_x,k_y,k_z)$. (For instance, in a purely symmetric
case, there is only one mode: $m=0$.) In addition, since the fields
$F_z, F_r, F_\theta$ are real, and since $J_m(x) =(-1)^mJ_{-m}(x)$ \citep{Abramowitz},
one has
\[ \spectral{F}_{z,-m}(k_z, k_\perp) = (-1)^m\spectral{F}_{z,m}^{*} (-k_z,
k_\perp) \qquad \spectral{F}_{+,-m}(k_z, k_\perp) =
(-1)^{m+1} \spectral{F}_{-,m}^{*} (-k_z, k_\perp) \]
This means that one only needs to study the evolution of the modes having $m\geq 0$, as the modes with $m<0$ can
be directly deduced from these fields.

\section{Numerical implementation}
\label{sec:implementation}

\subsection{Overview of the algorithm}

The algorithm presented here uses the above-mentioned representation
of the fields. Although the fields are represented by a few
2D arrays, the particles are still distributed in 3D and their motion
is integrated in 3D. However, due to the
lower number of cells in a 2D array, one can drastically reduce the
total number of particles and still have significative statistics.

Similarly to a Cartesian pseudo-spectral code, we do not perform the
current deposition and field gathering directly from the
macroparticles to the spectral space. (This is inefficient since the
deposition and gathering are local operations in real space -- i.e. affect
only the few cells next to the macroparticle -- but global operations
in spectral space -- i.e. they affect all the spectral modes
simultaneously.) Instead we use an intermediate grid where these
operations can be performed locally, and where the fields $\mathcal{F}_{u,m}$
are defined by
\begin{equation} 
\label{eq:IntermBwTrans}
F_u(\vec{r}) = \sum_{m=-\infty}^{\infty} \mathcal{F}_{u,m}(r,z)
e^{-im\theta} 
\end{equation}
\begin{equation}
\label{eq:IntermFwTrans}
\mathcal{F}_{u,m}(r,z) = \frac{1}{2\pi} \TInteg{\theta} \;
F_u(\vec{r})e^{im\theta}
\end{equation}
where ${F}$ is either ${E}$, ${B}$ or
${j}$ and $u$ is either $z$, $r$ or $\theta$. Notice that this representation is the
same as that of \citep{Lifschitz, Davidson}. Notice also that, in this
representation, we kept the spectral decomposition in the azimuthal
direction, since the factors $e^{im\theta}$ can be efficiently computed from the
particle positions by using the relation $e^{im\theta} = (x+iy)^m/r^m$
\citep{Lifschitz}.

After the particles deposit their charge and current onto this grid,
the fields of the intermediate grid are transformed into spectral
space where the Maxwell equations can be easily integrated. From
\cref{eq:IntermFwTrans,eq:IntermBwTrans} and
\cref{eq:CircFwTransz,eq:CircFwTransp,eq:CircFwTransm,eq:CircBwTransz,eq:CircBwTransr,eq:CircBwTranst}, the transformation between these
representations is:
\begin{align*}
\tilde{F}_{z,m}(k_z,k_\perp) & = \mathrm{HT}_{m} [ \; \mathrm{FT}
                               [ \; \mathcal{F}_{z,m}(r,z) \; ] \;]\\
\tilde{F}_{+,m}(k_z,k_\perp) &= \mathrm{HT}_{m+1}\left[ \; \mathrm{FT} \left[ \frac{
  \mathcal{F}_{r,m} -i  \mathcal{F}_{\theta,m} }{2}  \right] \;\right] \\
\tilde{F}_{-,m}(k_z,k_\perp) &= \mathrm{HT}_{m-1} \left[ \;\mathrm{FT} \left[ \frac{
  \mathcal{F}_{r,m} +i  \mathcal{F}_{\theta,m} }{2}  \right] \;\right] 
\end{align*}
and
\begin{align*}
\mathcal{F}_{z,m}(r,z) &= \mathrm{IFT} [\; \mathrm{IHT}_{m} [
                         \tilde{F}_{z,m}(k_z,k_\perp) ] \; ] \\
\mathcal{F}_{r,m}(r,z) & = \mathrm{IFT} \left[ \; \mathrm{IHT}_{m+1}
                         [ \tilde{F}_{+,m}(k_z,k_\perp) ] + \mathrm{IHT}_{m-1} [
                         \tilde{F}_{-,m}(k_z,k_\perp) ] \; \right] \\
\mathcal{F}_{\theta,m}(r,z) & = i\;\mathrm{IFT} \left[ \; \mathrm{IHT}_{m+1}
                         [ \tilde{F}_{+,m}(k_z,k_\perp) ] - \mathrm{IHT}_{m-1} [ \tilde{F}_{-,m}(k_z,k_\perp) ] \; \right]
\end{align*}
where $\mathrm{FT}$ represents a Fourier Transform along the $z$
axis and $\mathrm{HT}_{n}$ represents a Hankel Transform of order
$n$ along the $r$ axis, and where $\mathrm{IFT}$ and
$\mathrm{IHT}_{n}$ represent the corresponding inverse
transformations:
\[ \mathrm{FT} [f]\, (k_z) \equiv \Integ{z} \, e^{-ik_zz} \; f(z) \qquad 
\mathrm{IFT} [g] \,(z)\equiv \frac{1}{2\pi}\Integ{k_z} \, e^{ik_zz} \;  g(k_z)\]
\[ \mathrm{HT}_{n} [f]\,(k_\perp) \equiv 2\pi \RInteg{r} \,
J_{n}(k_\perp r) \; f(r) \qquad 
\mathrm{IHT}_{n} [g]\,(r) \equiv \frac{1}{2\pi}\RInteg{k_\perp} \,  J_{n}(k_\perp r)  \;  g(k_\perp) \]

The above equations show that the transformation from the intermediate
grid ($\mathcal{F}_{u,m}$) to the spectral grid ($\tilde{F}_{u,m}$) is
the combination of a Fourier transform (in $z$) and a Hankel transform
(in $r$). The Fourier transform in $z$ can be implemented through a Fast Fourier
Transform (FFT) algorithm, which requires the intermediate and spectral grid to
have regular spacing in $z$ and $k_z$ respectively. On the other hand,
there are a variety of existing algorithms (that are not mathematically
equivalent) to discretize the Hankel
transform (e.g. \citep{Cree,Yu,Siegman,Guizar,KaiMing}), and the use of one or the other
is very dependent of the particular application pursued. Broadly
speaking, most Discrete Hankel Transform (DHT) algorithms consists in 
\begin{enumerate}
\item Choosing a discrete grid in $r$ and $k_\perp$ space, on which to
  sample the functions to be transformed. In some algorithms, these
  grids may not be regularly spaced, and can be for instance
  logarithmically spaced \citep{Siegman} or correspond to the zeros of
  Bessel functions \citep{Yu,Guizar,KaiMing}.
\item Once a grid is chosen, the DHT amouts to a linear operation on a
  finite set of points (the points of the grid) and can thus be
  represented by a matrix. Thus the second choice is that of a matrix
  that represents (as closely as possible), the exact Hankel Transform.
\end{enumerate}
Here, we choose to discretize the algorithm on a regular grid in
space
\[ r_j = \Delta r \left( j+\frac{1}{2} \right) \qquad  j \in \{0, ...,
N_r-1 \} \qquad \mathrm{where} \quad \Delta r = \frac{r_{max}}{N_r} \]
(Notice that neither $r=0$, nor $r=r_{max}$ are part of the grid.)
but on a non-regular grid in $k$ space. This is because the authorized
$k$ are determined by the boundary conditions, in the same way that
the periodic boundaries in a Cartesian code impose the use of
regularly-space $k$. Here, for simplicity, we impose that the
longitudinal fields be $0$ at $r_{max}$ (i.e. $E_z(r_{max}, z) = 0$,
$B_z(r_{max}, z) = 0$). In this case, it turns out that the set of authorized
$k_\perp$ depend on the mode $m$ and reads
\[  k^m_{\perp,j} = \frac{\alpha_j^m}{r_{max}} \qquad j \in \{0, ..., N_r-1 \}\]
where $\alpha^m_j$ is the $j$th positive zero of the Bessel function of order
$m$ $J_m$ (including the trivial value $\alpha_0^m=0$ for
$m>0$). These values are represented in figure \ref{fig:Kgrid}. Notice
that the fact that the $k$s depend on the mode number $m$ is not a
problem since each mode evolves separately in
\cref{eq:CircMaxwellp,eq:CircMaxwellm,eq:CircMaxwellz}.

\begin{figure}[!h]
\includegraphics[width=\textwidth]{figures/KGrid.pdf}
\caption{\label{fig:Kgrid}Position of the grid points in $k$ space
  (blue dots) for the azimuthal modes $m=0$, $m=1$ and $m=2$ for $N_r
  = 10$ and $r_{max}=1$. These values are compared with those of a
  regularly-spaced grid used in Cartesian spectral codes (grey dots, $k_j = j\pi/r_{max}$)}
\end{figure}

Once this grid is set up, the discrete hankel transform is simply a
linear operation on a finite set of points, and can thus be
represented by a matrix operation
\[ \mathrm{DHT^m_n}[f] \,(k^m_j) = \sum_{p=0}^{N_r-1} (M_{n,m})_{j,p}
\,f(r_p) \qquad \mathrm{IDHT^m_n}[g] \, (r_j) = \sum_{p=0}^{N_r-1}
(M^{-1}_{n,m})_{j,p} \,g(k^m_p) \]

Notice that the $N_r\times N_r$ transformation matrices $M_{n,m}$ and
$M_{n,m}^{-1}$ depend on $n$ (order of the Hankel transform) and $m$
(index of the spectral grid $k^m_j$ on which the Hankel transform is calculated). The expression of these matrices,
for the DHT algorithm that we chose, is given in
\cref{sec:HTMatrix}. %This particular choice is very specific and
%dependent on the imposed boundary conditions at $r_{max}$ ; in future
%work, different implementations of the DHT could be used depending on
%the boundary conditions. 
In practice, $M_{n,m}$ and $M^{-1}_{n,m}$ need to be
computed only once (at initialization), and can then be used at each
iteration. Notice also that the computational time for this
matrix multiplication is proportional to $N_r^2$, which is slow
compared to an FFT ($\propto N_r \log(N_r)$), but
still faster than the 2D FFT ($\propto N_x N_y \log(N_x) + N_x N_y \log(N_y) $)
which is used in a Cartesian spectral code. In practice, for $N_x = N_y =
N_r = 1000$ for instance, the DHT can be 50 times faster than a 2D FFT \citep{Norfolk}.

\Cref{fig:GlobalScheme} sums up the steps of the PIC cycle, including the
respective role of the intermediate and spectral grid. Note that, in the PSATD
scheme that we chose (and which is described in more details in
\cref{sec:FieldIntegration}), all the fields are defined at integer
timesteps, except for the currents, which are defined at half
timesteps. The following section describe the successive steps of the cycle in more details.

\begin{figure}
\input{figures/PIC-cycle.tex}
\caption{Description of the PIC cycle \label{fig:GlobalScheme}}
\end{figure}

\subsection{Field gathering}

When gathering the fields from the intermediate grid to the macroparticles,
we use standard linear shape factors :
\begin{align} 
F_u(\vec{r}_k) &=  \sum_{p,q} S_{z,p}(z_k)S_{r,q}(r_k) \left[ \sum_{m=-N_m}^{N_m} \mathcal{F}_{u,m}(z_p, r_q)
  e^{-im\theta_k} \right] \\
& = \sum_{p,q} S_{z,p}(z_k)S_{r,q}(r_k) \left[ \mathcal{F}_{u,0}(z_p,
  r_q) + 2\,\Re \left( \sum_{m=1}^{N_m} \mathcal{F}_{u,m}(z_p, r_q)
  e^{-im\theta_k} \right) \right]
\end{align}
where $k$ is the index of the macroparticle, and $p$ and $q$ are the
indices of the neighboring cells, in $z$ and $r$ respectively. $N_m$ is the total number
of azimuthal modes used, and $S_{z,p}$ and $S_{z,q}$ are the linear
shape factors in $z$ and $r$ :
\[ S_{z,p_0}(z) = \frac{z_{p_0+1}- z}{\Delta z}  \qquad 
S_{z,p_0 +1}(z) = \frac{ z - z_{p_0} }{\Delta z} \qquad
\mathrm{with} \quad z_{p_0} \leq z < z_{p_0 +1}  \]
\[ S_{r,q_0}(r) = \frac{ r_{q_0+1} - r }{  \Delta r }
\qquad S_{r,q_0+1}(r) = \frac{ r - r_{q_0} }{  \Delta r }
\qquad \mathrm{with} \quad r_{q_0} \leq r < r_{q_0+1}
 \]

\subsection{Equations of motion}

Since the particle motion is studied in 3D, we use the standard Vay pusher (citation).

\subsection{Current deposition}

The charge density is calculated on the interpolation grid in the
following way:
\[ \mathcal{\rho}_m(z_p,r_q) = \frac{ \sum_k  S_{z,p}(z_k)S_{r,q}(r_k) Q_k e^{im\theta_k}}{V_{q}} \]
where $Q_k$ is the charge of the macroparticle with index $k$, and
where $V_q$ is the volume of a cell
\[ V_{q} = \pi [\, (q+1)^2- q^2\,] \Delta r^2 \Delta z \]

Similarly, the current deposition is given by
\[ \mathcal{J}_{u,m}(z_p,r_q) = \frac{\sum_k S_{z,p}(z_k) S_{r,q}(r_k)
Q_k v_{u,k} e^{im\theta_k}}{V_{q}} \]
where $u = z,r,\theta$ and the $v_{u,k}$ are the cylindrical components of the
velocity of the macroparticle $k$. Notice that we do not attempt to
reproduce the Esirkepov current deposition here, and instead use a
much simpler current deposition. As mentioned previously, once the
macroparticles have deposited their charge and current on the
intermediate grid, we transform them to the spectral grid, using an
FFT and a DHT.

The above simple deposition does not necessarily
preserve the relation $\partial_t\rho + \vec{\nabla}\cdot\vec{j} =
0$. When $\partial_t\rho + \vec{\nabla}\cdot\vec{j}$ is different than 0,
one can correct for that error, by slightly modifying the currents, in
a way that does not modify the value of their curl:
\[ \vec{j}' = \vec{j} - \vec{\nabla} F \]
where $F$ satisfies the Poisson-like equation
\[ \vec{\nabla}^2 F = \partial_t\rho + \vec{\nabla}\cdot\vec{j} \]
The above equation is typically expensive to solve on a spatial grid, but
very easy to solve in spectral space. In our scheme and in spectral
space, these equations become
\[ \tilde{j}'^{n+1/2}_{+,m} = \tilde{j}^{n+1/2}_{+,m} +
\frac{k_\perp}{2} \tilde{F}^{n+1/2}_m
\qquad
\tilde{j}'^{n+1/2}_{-,m} = \tilde{j}^{n+1/2}_{-,m} - \frac{k_\perp}{2} \tilde{F}^{n+1/2}_m
\qquad \tilde{j}'^{n+1/2}_{z,m} = \tilde{j}^{n+1/2}_{z,m} - ik_z
\tilde{F}^{n+1/2}_m\]
with
\[ \tilde{F}^{n+1/2}_m = - \frac{1}{k_\perp^2 + k_z^2}\left(
  \frac{\tilde{\rho}^{n+1}_m -\tilde{\rho}^{n}_m}{\Delta t} + k_\perp
  (\tilde{j}^{n+1/2}_{+,m} -\tilde{j}^{n+1/2}_{-,m}) + ik_z\tilde{j}^{n+1/2}_{z,m}  \right) \]
With this correction, the new currents $\tilde{j}'^{n+1/2}$ do satisfy
the charge conservation equation \cref{eq:SpectCharge}. Therefore we apply this
correction at the end of the current deposition, at each timestep.

\subsection{Field integration}
\label{sec:FieldIntegration}

The Maxwell equations
\cref{eq:CircMaxwellp,eq:CircMaxwellm,eq:CircMaxwellz} could in
principle be integrated in time by using a finite difference scheme:
\begin{align*}
\tE{+}{n+1} = \; & \tE{+}{n} + 
c^2\Delta t\left(-\frac{ik_\perp }{2} \tB{z}{n} + k_z\tB{+}{n}
- \mu_0 \tj{+}{n+1/2} \right) & \\
\tE{-}{n+1} =\; & \tE{-}{n} +
c^2\Delta t\left(- \frac{ik_\perp }{2} \tB{z}{n} - k_z\tB{-}{n}
- \mu_0 \tj{-}{n+1/2} \right) &\\
\tE{z}{n+1} =\; & \tE{z}{n} + 
c^2\Delta t\left(ik_\perp \tB{+}{n} + ik_\perp \tB{-}{n}
- \mu_0 \tj{z}{n+1/2} \right)  &
\end{align*}
\begin{align*}
\tB{+}{n+1} = \; & \tB{+}{n} - 
\Delta t\left(-\frac{ik_\perp }{2} \tE{z}{n} + k_z\tE{+}{n}
\right) & \\
\tB{-}{n+1} =\; & \tB{-}{n} - 
\Delta t\left(- \frac{ik_\perp }{2} \tE{z}{n} - k_z\tE{-}{n}
\right) &\\
\tB{z}{n+1} =\; & \tB{z}{n} - 
\Delta t\left(ik_\perp \tE{+}{n} + ik_\perp \tE{-}{n}
\right) &
\end{align*}
However, this type of scheme retains some amount of numerical dispersion, and can
thus affect the simulated physics.

Instead, here we use an adaptation of the PSATD scheme \citep{Haber} for the
Fourier-Bessel spectral space. Similarly to the case of the standard
PSATD, we assume that the currents are constant over one timestep and
the charge is linear in time over the same timestep. Under these
assumptions, the Maxwell equations \cref{eq:CircMaxwellp,eq:CircMaxwellm,eq:CircMaxwellz} can be integrated
analytically over that timestep, and they lead to:
\begin{align*}
\tE{+}{n+1} = \; & C \tE{+}{n} + 
c^2\frac{S}{\omega}\left(-\frac{ik_\perp }{2} \tB{z}{n} + k_z\tB{+}{n}
- \mu_0 \tj{+}{n+1/2} \right) + \frac{c^2}{\epsilon_0}
\frac{k_\perp}{2}\left[ \frac{\trho{n+1}}{\omega^2}\left(
  1 - \frac{S}{\omega\Delta t}\right) -
\frac{\trho{n}}{\omega^2}\left( C -\frac{S}{\omega\Delta t}\right)\right]  & \\
\tE{-}{n+1} =\; & C \tE{-}{n} +
c^2\frac{S}{\omega}\left(- \frac{ik_\perp }{2} \tB{z}{n} - k_z\tB{-}{n}
- \mu_0 \tj{-}{n+1/2} \right) - \frac{c^2}{\epsilon_0}
\frac{k_\perp}{2}\left[ \frac{\trho{n+1}}{\omega^2}\left(
  1 - \frac{S}{\omega\Delta t}\right) - \frac{\trho{n}}{\omega^2}
\left( C - \frac{S}{\omega\Delta t}\right)\right]  &\\
\tE{z}{n+1} =\; & C \tE{z}{n} + 
c^2\frac{S}{\omega}\left(ik_\perp \tB{+}{n} + ik_\perp \tB{-}{n}
- \mu_0 \tj{z}{n+1/2} \right) - \frac{c^2}{\epsilon_0}
ik_z\left[ \frac{\trho{n+1}}{\omega^2}\left(
  1 - \frac{S}{\omega\Delta t}\right) - \frac{\trho{n}}{\omega^2}
\left( C - \frac{S}{\omega\Delta t}\right)\right]  &
\end{align*}
\begin{align*}
\tB{+}{n+1} = \; & C \tB{+}{n} - 
\frac{S}{\omega}\left(-\frac{ik_\perp }{2} \tE{z}{n} + k_z\tE{+}{n}
\right) + \mu_0 c^2\frac{1-C}{\omega^2} \left( -\frac{ik_\perp }{2}
  \tj{z}{n+1/2} + k_z \tj{+}{n+1/2} \right)& \\
\tB{-}{n+1} =\; & C \tB{-}{n} - 
\frac{S}{\omega}\left(- \frac{ik_\perp }{2} \tE{z}{n} - k_z\tE{-}{n}
\right) + \mu_0 c^2\frac{1-C}{\omega^2} \left( - \frac{ik_\perp }{2}
  \tj{z}{n+1/2} - k_z \tj{-}{n+1/2} \right) &\\
\tB{z}{n+1} =\; & C \tB{z}{n} - 
\frac{S}{\omega}\left(ik_\perp \tE{+}{n} + ik_\perp \tE{-}{n}
\right) + \mu_0 c^2\frac{1-C}{\omega^2} \left( ik_\perp
  \tj{+}{n+1/2} + ik_\perp \tj{-}{n+1/2} \right)&
\end{align*}


where $\omega= c\sqrt{k_z^2 + k_\perp^2}$, $C = \cos(\omega \Delta t)$
and $S = \sin(\omega \Delta t) $. (See \cref{sec:PSTADderiv} for a
derivation.)

\section{Benchmarks}
\label{sec:benchmarks}

\subsection{Propagation in vacuum}

\subsection{Propagation in a plasma}

\subsection{Linear plasma wave}

\section{Advantages over finite-difference codes}
\label{sec:advantages}

Mention obvious advantage with better numerical dispersion : dephasing
length will be better predicted (cite Cowan). 

Mention suffer from parallelization problems.


\subsection{Absence of numerical Cherenkov radiation}

\subsection{Accurate force of a laser on a relativistic electron}


\section*{Conclusion}

Few published codes have the above advantages in Cartesian geometry (aside
from spectral codes, directional splitting may have similar
advantages). Here on top of it, we have it in Circ.

\paragraph{Acknowledgements}

We thank Brendan Godfrey for very valuable comments and
suggestions. We also acknowledge Igor A. Andriyash for fruitful
discussions.

\newpage
\appendix

\input{appendix.tex}

\bibliography{Bibliography}
\bibliographystyle{plainnat}

\end{document}  
