\documentclass[a4paper]{article}   	% use "amsart" instead of "article" for AMSLaTeX format

\usepackage{geometry}               	
\geometry{a4paper,margin=1.1in}           % ... or a4paper or a5paper or ... 

%\usepackage{graphicx}			

\usepackage{amsmath}
\usepackage{tikz}

\usepackage{hyperref}
\hypersetup{colorlinks=true,
    citecolor=blue,    filecolor=blue,
    linkcolor=blue,     urlcolor=blue
}
\usepackage{cite}

\newcommand{\ir}{\frac{1}{r}}
\newcommand{\Integ}[1]{\int_{-\infty}^{\infty} \!\!\!\!\!
  \mathrm{d}#1}
\newcommand{\RInteg}[1]{\int_{0}^{\infty} \!\!\!\!\! #1\mathrm{d}#1}
\newcommand{\TInteg}[1]{\int_{0}^{2\pi} \!\!\!\!\! \mathrm{d}#1}

\newcommand{\tB}[2]{\tilde{B}_{#1,m}^{#2}}
\newcommand{\tE}[2]{\tilde{E}_{#1,m}^{#2}}
\newcommand{\tj}[2]{\tilde{j}_{#1,m}^{#2}}

\newcommand{\trho}[1]{\tilde{\rho}_{m}^{#1}}

% Reference automatique aux equations, sections, figures
\usepackage{cleveref}

\title{A pseudo-spectral, cylindrical and dispersion-free Particle-In-Cell algorithm}
%\pagestyle{empty}
\author{R\'emi \textsc{Lehe}}

% Mettre les c2 partout

\begin{document}

\maketitle


\section*{Introduction (rough ideas)}

\paragraph{Importance of PIC codes } Used in many fields : astro, laser-plasma interaction. However, 3D codes are expensive, and their limited resolution leads to many numerical effects (Cherenkov, dispersion).

\paragraph{Cylindrical PIC codes} A range of physical situations have close-to cylindrical symmetry (e.g. electron beam propagation, laser-wakefield acceleration), and they can be simulated with very significant speedup using a cylindrically symmetric algorithm \cite{Lifschitz, Davidson}. This typically reduces the cost of the simulation to a few times that of a 2D simulation, instead of that of a full 3D simulation.

\paragraph{Spectral PIC codes} In parallel, 3D spectral PIC codes have been developped, and can mitigate numerical instability (articles Warren and Brendan Godfrey). In spectral space, some algorithms have no numerical dispersion whatsoever \cite{Haber}. This is important in laser-wakefield acceleration since even a very small amount of numerical dispersion can introduce spurious injection. Dispersion is also important when simulating beam physics, where lower-than-c propagation leads to Cherenkov effect and faster-than-c leads to fields unphysically traveling ahead of the beam. Typically, this imposes to strongly overresolve the wavelength of the laser (thereby increasing computational requirements), and to use very asymetric cell aspect ratio. Although the spectral algorithms reduce the requirements on the longitudinal resolution, they still require a 3D grid, and therefore a large computational load.

\paragraph{Spectral, cylindrical PIC codes } In this document, we combine the two approaches. Advantages:
\begin{itemize}
\item Significant speedup due to the cylindrical geometry, and the
  lower number of particles.
\item Ideal dispersion relation in PSATD, independent on azimuthal mode (with a finite difference algorithm, the different modes go at different speeds)
\item Fields are colocated in space and time in PSATD and not
  staggered, which simplifies interpolation, and prevents
  time-interpolation errors in compensation of E and B (article plasma
  lens)
\item Time step can be bigger (but still need to resolve the
  oscillations of the particles in time).
\item Ability to apply filters in k space and thereby limit numerical instabilities
\item Prevent on-axis noise that appear in finite-difference cylindrical algorithms.
\end{itemize}


\section{Representation of the fields and continuous equations}

\subsection{Reminder on Cartesian spectral codes}

It is well-known that the Maxwell equations in Cartesian coordinates 
\begin{align}
\frac{1}{c^2}\partial_t E_x = \partial_y B_z - \partial_z B_y - \mu_0  j_x \qquad&   
\partial_t B_x = -\partial_y E_z + \partial_z E_y \label{eq:CartMaxwellx} \\
\frac{1}{c^2}\partial_t E_y = \partial_z B_x - \partial_x B_z - \mu_0  j_y \qquad &   
\partial_t B_y = -\partial_z E_x + \partial_x E_z \label{eq:CartMaxwelly}  \\
\frac{1}{c^2}\partial_t E_z = \partial_x B_y - \partial_y B_x - \mu_0  j_z \qquad &   
\partial_t B_z = -\partial_x E_y + \partial_y E_x \label{eq:CartMaxwellz} 
\end{align}
can be solved by representing the fields as a sum of Fourier modes.
\begin{equation}
\label{eq:CartBwTrans}
F_u(\vec{r}) = \frac{1}{(2\pi)^{3/2}}\Integ{k_x} \,\Integ{k_y}\, \Integ{k_z} \; \hat{F}_u(\vec{k}) e^{i(k_x x + k_y y + k_z z)} 
\end{equation}
with 
\begin{equation}
\label{eq:CartFwTrans}
\hat{F}_u(\vec{k})  = \frac{1}{(2\pi)^{3/2}}\Integ{x} \,\Integ{y}\, \Integ{z} \; F_u(\vec{r}) e^{-i(k_x x + k_y y + k_z z)} 
\end{equation}
where $F$ is any of the fields $E$, $B$ or $j$, and where $u$ is
either $x$, $y$ or $z$. In this case, the different Fourier modes decouple and the equations \cref{eq:CartMaxwellx,eq:CartMaxwelly,eq:CartMaxwellz} become 
\begin{align}
\frac{1}{c^2}\partial_t \hat{E}_x = ik_y \hat{B}_z - ik_z \hat{B}_y - \mu_0 \hat{j}_x \qquad &   
\partial_t \hat{B}_x = -ik_y \hat{E}_z + ik_z \hat{E}_y \\
\frac{1}{c^2}\partial_t \hat{E}_y = ik_z \hat{B}_x - ik_x \hat{B}_z - \mu_0  \hat{j}_y \qquad &   
\partial_t \hat{B}_y = -ik_z \hat{E}_x + ik_x \hat{E}_z \\
\frac{1}{c^2}\partial_t \hat{E}_z = ik_x \hat{B}_y - ik_y \hat{B}_x - \mu_0 \hat{j}_z  \qquad &   
\partial_t \hat{B}_z = -ik_x \hat{E}_y + ik_y \hat{E}_x 
\end{align}
The Fourier coefficients can then be integrated in time, and
transformed back into real space using \cref{eq:CartBwTrans}. This is
the core principle of Cartesian pseudo-spectral time-domain (PSTD)
codes and pseudo-spectral analytical time-domain (PSATD) codes.

\subsection{Cylindrical spectral decomposition}

The Fourier representation \cref{eq:CartBwTrans} is no longer the
appropriate representation when the Maxwell equations are written in cylindrical coordinates.
\begin{align}
\frac{1}{c^2}\partial_t E_r = \ir \partial_\theta B_z - \partial_z B_\theta - \mu_0  j_r \qquad&   
\partial_t B_r = -\ir \partial_\theta E_z + \partial_z E_\theta \label{eq:CircMaxwellr} \\
\frac{1}{c^2}\partial_t E_\theta = \partial_z B_r - \partial_r B_z - \mu_0  j_\theta \qquad &   
\partial_t B_\theta = -\partial_z E_r + \partial_r E_z \label{eq:CircMaxwellt}  \\
\frac{1}{c^2}\partial_t E_z = \ir\partial_r r B_\theta - \ir\partial_\theta B_r - \mu_0  j_z \qquad & 
\partial_t B_z = -\ir\partial_r r E_\theta + \ir\partial_\theta E_r \label{eq:CircMaxwellzz} 
\end{align}
When replacing
\cref{eq:CartBwTrans} into the \cref{eq:CircMaxwellr,eq:CircMaxwellt,eq:CircMaxwellzz}, the Fourier modes do not decouple. Instead one has to use the Fourier-Bessel representation.
\begin{align}
& F_u(\vec{r}) = \sum_{m=-\infty}^{\infty} \Integ{k_z}
\RInteg{k_\perp }\; \tilde{F}_{u,m}(k_z,k_\perp ) \; J_m(k_\perp r)\, e^{-im\theta + ik_z z} 
\label{eq:CircBwTransu} \\
& F_r(\vec{r}) = \sum_{m=-\infty}^{\infty} \Integ{k_z}\,\RInteg{k_\perp }\;
\left( \tilde{F}_{+,m}(k_z,k_\perp )\; J_{m+1}(k_\perp r) +\tilde{F}_{-,m}(k_z,k_\perp )\; J_{m-1}(k_\perp r)
\right)  e^{-im\theta +ik_z z}
\label{eq:CircBwTransr} \\
& F_\theta(\vec{r}) = \sum_{m=-\infty}^{\infty} \Integ{k_z}\,\RInteg{k_\perp }\;
i\left( \tilde{F}_{+,m}(k_z,k_\perp )\; J_{m+1}(k_\perp r) - \tilde{F}_{-,m}(k_z,k_\perp )\; J_{m-1}(k_\perp r)
\right)  e^{-im\theta +ik_z z} 
\label{eq:CircBwTranst}
\end{align}
where $F$ is either $E$, $B$ or $j$ and $u$ is any of the
Cartesian components $x$, $y$ or $z$. Notice that the Cartesian
components ($F_u$ with $u$ = $x,y,z$) and cylindrical components
($F_r$, $F_\theta$) do not transform in the same manner, which is due
to their different behavior close to the axis. (See
\cref{sec:CircTrans} for a derivation of this representation and for
its relation to the Fourier transform.) In addition, the coefficients $\tilde{F}_u$, $\tilde{F}_+$ and
 $\tilde{F}_{-}$ are given by:
\begin{align}
\tilde{F}_{u,m}(k_z,k_\perp ) = \frac{1}{(2\pi)^2} \Integ{z} \RInteg{r}
\TInteg{\theta} \;F_u(\vec{r})\; J_m(k_\perp r) e^{im\theta
 - i k_z z} \label{eq:CircFwTransu} \\
\tilde{F}_{+,m} = \frac{\tilde{F}_{x,m+1} -
    i\tilde{F}_{y,m+1}}{2} \qquad \tilde{F}_{-,m} = \frac{\tilde{F}_{x,m-1} +
    i\tilde{F}_{y,m-1}}{2}
\label{eq:CircFwTranspm} 
\end{align}
\noindent Note also that scalar fields (like $\rho$) transform in the same way as the Cartesian components $F_u$.

When replacing \cref{eq:CircBwTransr,eq:CircBwTranst,eq:CircBwTransu}
(for $u=z$) into the Maxwell equations in cylindrical
coordinates \cref{eq:CircMaxwellr,eq:CircMaxwellt,eq:CircMaxwellzz},
the different modes decouple, and the equations for the spectral
coefficients become:
\begin{align}
\frac{1}{c^2}\partial_t \tilde{E}_{+,m} = - \frac{ik_\perp }{2}\tilde{B}_{z,m} + k_z\tilde{B}_{+,m} - \mu_0\tilde{j}_{+,m} \qquad &   
\partial_t \tilde{B}_{+,m} = \frac{ik_\perp }{2} \tilde{E}_{z,m} - k_z
\tilde{E}_{+,m} 
\label{eq:CircMaxwellp} \\
\frac{1}{c^2}\partial_t \tilde{E}_{-,m} = -\frac{ik_\perp }{2} \tilde{B}_{z,m} - k_z \tilde{B}_{-,m} - \mu_0  \tilde{j}_{-,m} \qquad &   
\partial_t \tilde{B}_{-,m} = \frac{ik_\perp }{2} \tilde{E}_{z,m} + k_z
\tilde{E}_{-,m} \label{eq:CircMaxwellm} \\
\frac{1}{c^2}\partial_t \tilde{E}_{z,m} = ik_\perp  \tilde{B}_{+,m} + ik_\perp \tilde{B}_{-,m}  - \mu_0 \tilde{j}_{z,m}  \qquad & 
\partial_t \tilde{B}_{z,m} = -ik_\perp  \tilde{E}_{+,m} - ik_\perp \tilde{E}_{-,m}  \label{eq:CircMaxwellz} 
\end{align}
(See \cref{sec:SpectMaxwell} for a derivation of these equations.) In
addition, the conservation equations
$\vec{\nabla}\cdot\vec{E}=\rho/\epsilon_0$ and
$\vec{\nabla}\cdot\vec{B} = 0$
become
\begin{equation}
\label{eq:SpectCons}
k_\perp (\tilde{E}_{+,m} -\tilde{E}_{-,m}) + ik_z \tilde{E}_{z,m} =
\frac{\tilde{\rho}_m}{\epsilon_0} \qquad
 k_\perp (\tilde{B}_{+,m} -\tilde{B}_{-,m}) + ik_z \tilde{B}_{z,m} =
0 \end{equation}
As expected, the above conservation equations are
preserved by the Maxwell equations
\cref{eq:CircMaxwellp,eq:CircMaxwellm,eq:CircMaxwellz}, provided
that the current satisfies $\partial_t
\rho + \vec{\nabla} \cdot \vec{j} = 0$, i.e. in spectral space:
\begin{equation}
\label{eq:SpectCharge}
\partial_t \tilde{\rho}_m + k_\perp (\tilde{j}_{+,m} -\tilde{j}_{-,m}) + ik_z
\tilde{j}_{z,m} = 0
\end{equation}  

Again, the equations \cref{eq:CircMaxwellp,eq:CircMaxwellm,eq:CircMaxwellz}  can be
integrated in time, and the fields can then be transformed back into
real space, using \cref{eq:CircBwTransu,eq:CircBwTransr,eq:CircBwTranst}. Notice that
the structure of \cref{eq:CircMaxwellp,eq:CircMaxwellm,eq:CircMaxwellz} is similar to
the structure of the corresponding equations in a Cartesian PIC code. Therefore,
the methods used to integrate the fields in time in a Cartesian
spectral code (e.g. PSATD) should be transposable to the cylindrical case.

Typically one needs only a few modes in $m$, therefore the fields are
reduced to a few 2D tables $\tilde{F}_m(k_z,k_\perp )$ instead of the
3D tables $\hat{F}(k_x,k_y,k_z)$. (For instance, in a purely symmetric
case, there is only one mode: $m=0$.) In addition, since the fields
$F_u$ are real, one has $\tilde{F}_{u,-m}(k_z, k_\perp) =
\tilde{F}_{u,m}(-k_z, k_\perp)^{*}$ and $\tilde{F}_{+,-m}(k_z, k_\perp) =
\tilde{F}_{-,m}(-k_z, k_\perp)^{*}$. This means that one only needs to study the evolution of the modes having $m\geq 0$, as the modes with $m<0$ can
be directly deduced from these fields.

\section{Numerical implementation}

\subsection{Overview of the algorithm}

The algorithm presented here uses the above-mentioned representation
of the fields. However, although the fields are represented by a few
2D arrays, the particles are still distributed in 3D and their motion
is integrated in 3D. However, due to the
lower number of cells in a 2D array, one can drastically reduce the
total number of particles and still have significative statistics.

Similarly to a Cartesian pseudo-spectral code, we do not perform the
current deposition and field gathering directly from the
macroparticles to the spectral space. (This is inefficient since the
deposition and gathering are local operations in real space -- i.e. affect
only the few cells next to the macroparticle -- but global operations
in spectral space -- i.e. they affect all the spectral modes
simultaneously.) Instead we use an intermediate grid where these
operations can be performed locally, and where the fields
are defined by
\begin{equation} 
\label{eq:IntermBwTrans}
F_u(\vec{r}) = \sum_{m=-\infty}^{\infty} \mathcal{F}_{u,m}(r,z)
e^{-im\theta} 
\end{equation}
\begin{equation}
\label{eq:IntermFwTrans}
\mathcal{F}_{u,m}(r,z) = \frac{1}{2\pi} \TInteg{\theta} \;
F_u(\vec{r})e^{im\theta}
\end{equation}
where $\mathcal{F}$ is either $\mathcal{E}$, $\mathcal{B}$ or
$\mathcal{J}$ and $u$ is either one of the Cartesian components $x$,
$y$ and $z$. (Notice that this representation is very similar to that
of \cite{Lifschitz, Davidson}, except that, instead of the $r$ and
$\theta$ components, we use the Cartesian components $x$ and $y$ at
this point, which is easier for current deposition, since the
particles motion is studied in 3D. Notice also that, in this
representation, we kept the spectral decomposition in the azimuthal
direction, since factors $e^{im\theta}$ are easily computed from the
particle positions (see \cite{Lifschitz})).

After the particles deposit their charge and current onto this grid,
the fields of the intermediate grid are transformed into spectral
space where the Maxwell equations can be easily integrated. From
\cref{eq:IntermFwTrans,eq:IntermBwTrans} and
\cref{eq:CircFwTransu,eq:CircBwTransu}, the transformation between these
representations is:
\[ \tilde{F}_{u,m}(k_z,k_\perp) =  \frac{1}{2\pi} \Integ{z} \RInteg{r} \;
\mathcal{F}_{u,m}(r,z) \, J_m(k_\perp r) e^{- ik_z z} \]
\[ \mathcal{F}_{u,m}(r,z) = \Integ{k_z}
\RInteg{k_\perp }\; \tilde{F}_{u,m}(k_z,k_\perp ) \; J_m(k_\perp r)\, e^{ik_z z}   \]
The above equations show that the transformation from the intermediate
grid ($\mathcal{F}_{u,m}$) to the spectral grid ($\tilde{F}_{u,m}$) is
the combination of a Fourier transform (in $z$) and a Hankel transform
(in $r$). The Fourier transform in $z$ can be implemented through a Fast Fourier
Transform (FFT) algorithm, which requires the intermediate and spectral grid to
have regular spacing in $z$ and $k_z$ respectively. On the other hand,
there are a variety of algorithms for implementing the Hankel Transform
(e.g. \cite{Cree,Siegman,Guizar}). Here, we choose the
implementation described in \cite{Guizar}, since -- unlike several other
implementations -- that particular implementation ensures that the
successive application of a Discrete Hankel Transform (DHT) and inverse Hankel Transform (iDHT)
retrieves the original function. However, this method imposes to use a
slightly non-uniform grid in $r$ and $k_\perp$ (corresponding to the
zeros of the function $J_m$), and moreover to use a
different grid for each azimuthal mode, since the position of the
gridpoints depends on $m$:
\[ r^m_j = r_{max} \frac{\alpha^m_j }{\alpha^m_{N_r+1}} \qquad
k_{\perp,j}^{m}  = \frac{1}{r_{max}} \alpha^{m}_j \qquad j \in \{1, ..., N_r \} \]
where $\alpha^{m}_j$ is the $j^{th}$ zero of the Bessel function of
order $m$ ($J_m$), and where $r_{max}$ is the outer boundary of the
simulation box. Notice that using a different grid for each azimuthal mode does
not pose any problem in principle since each mode evolves
independently in spectral space. It is also important to notice that
in a PSTD scheme (or PSATD scheme), the fields are not staggered, and
can thus all be defined at the same $k^{m}_{\perp,j}$ (in spectral
space) and $r^m_j$ (in real space).

Once this grid has been set up, this implementation of the DHT amounts
to a simple matrix multiplication, where the mutliplying matrix can be
computed only once, at initialization \cite{Guizar}:
\[ \mathrm{DHT :}\qquad  \tilde{f}(k^m_{\perp,j}) =
\sum_{\ell=1}^{N_r}
\frac{ J_{m}\left(\alpha^m_j \alpha^m_\ell /
      \alpha^m_{N_r+1}  \right) }{ \pi (\alpha^m_{N_r + 1})^2
    J_{m+1}(\alpha^m_{N_r + 1})^2 } f(r^m_\ell)\]
The computational time for this matrix multiplication is proportional
to $N_r^2$, which is slow compared to an FFT ($N_r \log(N_r)$), but
still faster than the 2D FFT ($N_x N_y \log(N_x) + N_x N_y \log(N_y) $)
which is used in a Cartesian spectral code. Moreover, the impact of
this relatively slow transform is mitigated by the fact that, in a PIC
code, the computational time is often dominated by the current deposition onto
the interpolation grid, which is independent of the above transform.


\Cref{fig:GlobalScheme} sums up the steps of the PIC cycle, including the
respective role of the intermediate and spectral grid. Note that, in the PSATD
scheme that we chose (and which is described in more details in
\cref{sec:FieldIntegration}), all the fields are defined at integer
timesteps, except for the currents, which are defined at half
timesteps. The following section describe the successive steps of the cycle in more details.

\begin{figure}
\input{PIC-cycle.tex}
\caption{Description of the PIC cycle \label{fig:GlobalScheme}}
\end{figure}

\subsection{Field gathering}

When gathering the fields from the intermediate grid to the macroparticles,
we use standard linear shape factors :
\[ F_u(\vec{r}_k) = \sum_{m=-N_m}^{N_m} \sum_{p,q} S_{z,p}(z_k)
S^m_{r,q}(r_k) \mathcal{F}_{u,m}(z_p, r_q) e^{-im\theta_k} \]
where $k$ is the index of the macroparticle, and $p$ and $q$ are the
indices of the neighboring cells, in $z$ and $r$ respectively. $N_m$ is the total number
of azimuthal modes used, and $S_{z,p}$ and $S^m_{r,q}$ are the linear
shape factors in $z$ and $r$ (where $S^m_r$ has to be adapted to the
non-uniform grid for the $m^{th}$ mode) :
\[ S_{z,p_0}(z) = \frac{(p_0+1)\Delta z - z}{\Delta z}  \qquad 
S_{z, p_0 +1}(z) = \frac{ z - p_0 \Delta z}{\Delta z} \qquad
\mathrm{with} \quad p_0 \Delta z \leq z < (p_0 +1) \Delta z \]
\[ S^m_{r,q_0}(r) = \frac{ r^m_{q_0+1} - r }{  r^m_{q_0+1} - r^m_{q_0} }
\qquad S^m_{r,q_0+1}(r) = \frac{ r - r^m_{q_0} }{  r^m_{q_0+1} - r^m_{q_0} }
\qquad \mathrm{with} \quad r^m_{q_0} \leq r < r^m_{q_0+1} \]
In addition, $S^m_{r,1}(r) = 1$ for $r<r^m_1$ i.e. any macroparticle
located below the first node of the grid deposits depends only on that
first node. (This is because $r^m_0=0$ is technically not part of the grid.)

\subsection{Equations of motion}

Since the particle motion is studied in 3D, we use the standard Boris pusher.

\subsection{Current deposition}

In order to deposit the charge onto the non-uniform
transverse grid, we use the method described in \cite{Verboncoeur},
which uses corrected cells volumes $V_{m,q}$ in order to have a
uniform density on the grid, when the macroparticles are uniformly distributed. :
\[ \mathcal{\rho}_m(z_p,r_q) = \sum_k  \frac{S_{z,p}(z_k) S^m_{r,q}(r_k) Q_k e^{im\theta_k}}{V_{m,q}} \]
where $Q_k$ is the charge of the macroparticle with index $k$.
\[ V_{m,q} = \frac{4}{3} \frac{ r_{q-1} + r_q + r_{q+1} }{ r_{q-1}
  + 2r_q + r_{q+1} } \pi (r_{q+1/2}^2 - r_{q-1/2}^2) \Delta z  \qquad
V_{m,1} = \frac{4}{3} \frac{2r_2^2 - r_2r_1 + 2r_1^2}{r_2^2 + 2r_2 r_1 +
  r_1^2 }\pi r_{3/2}^2 \Delta z \]
\[ \mathrm{with} \qquad r_{q+1/2} = \frac{r_{q+1} + r_q}{2}\]
(The volume $V_{m,1}$ differs from the expression in
\cite{Verboncoeur}, since is our case $r_0=0$ is not part of the grid.) Similarly, the current deposition is given by
\[ \mathcal{J}_{u,m}(z_p,r_q) = \sum_k  \frac{S_{z,p}(z_k) S^m_{r,q}(r_k)
Q_k v_{u,k} e^{im\theta_k}}{V_{m,q}} \]
where $u = x,y,z$ and the $v_{u,k}$ are Cartesian components of the
velocity of the macroparticle $k$. Notice that we do not attempt to
reproduce the Esirkepov current deposition here, and instead use a
much simpler current deposition. As mentioned previously, once the
macroparticles have deposited their charge and current on the
intermediate grid, we transform them to the spectral grid, using an
FFT and a DHT.

The above simple deposition does not necessarily
preserve the relation $\partial_t\rho + \vec{\nabla}\cdot\vec{j} =
0$. When $\partial_t\rho + \vec{\nabla}\cdot\vec{j}$ is different than 0,
one can correct for that error, by slightly modifying the currents, in
a way that does not modify the value of their curl:
\[ \vec{j}' = \vec{j} - \vec{\nabla} F \]
where $F$ satisfies the Poisson-like equation
\[ \vec{\nabla}^2 F = \partial_t\rho + \vec{\nabla}\cdot\vec{j} \]
The above equation is typically expensive to solve on a spatial grid, but
very easy to solve in spectral space. In our scheme and in spectral
space, these equations become
\[ \tilde{j}'^{n+1/2}_{+,m} = \tilde{j}^{n+1/2}_{+,m} +
\frac{k_\perp}{2} \tilde{F}^{n+1/2}_m
\qquad
\tilde{j}'^{n+1/2}_{-,m} = \tilde{j}^{n+1/2}_{-,m} - \frac{k_\perp}{2} \tilde{F}^{n+1/2}_m
\qquad \tilde{j}'^{n+1/2}_{z,m} = \tilde{j}^{n+1/2}_{z,m} - ik_z
\tilde{F}^{n+1/2}_m\]
with
\[ \tilde{F}^{n+1/2}_m = - \frac{1}{k_\perp^2 + k_z^2}\left(
  \frac{\tilde{\rho}^{n+1}_m -\tilde{\rho}^{n}_m}{\Delta t} + k_\perp
  (\tilde{j}^{n+1/2}_{+,m} -\tilde{j}^{n+1/2}_{-,m}) + ik_z\tilde{j}^{n+1/2}_{z,m}  \right) \]
With this correction, the new currents $\tilde{j}'^{n+1/2}$ do satisfy
the charge conservation equation \cref{eq:SpectCharge}. Therefore we apply this
correction at the end of the current deposition, at each timestep.

\subsection{Field integration}
\label{sec:FieldIntegration}

We use an adaptation of the PSATD scheme \cite{Haber} for the
Fourier-Bessel spectral space. Similarly to the case of the standard
PSATD, we assume that the currents are constant over one timestep and
the charge is linear in time over the same timestep. Under these
assumptions, the Maxwell equations \cref{eq:CircMaxwellp,eq:CircMaxwellm,eq:CircMaxwellz} can be integrated
analytically over that timestep, and they lead to:
\begin{align*}
\tB{+}{n+1} = \; & C \tB{+}{n} - 
\frac{S}{\omega}\left(-\frac{ik_\perp }{2} \tE{z}{n} + k_z\tE{+}{n}
\right) + \mu_0 c^2\frac{1-C}{\omega^2} \left( -\frac{ik_\perp }{2}
  \tj{z}{n+1/2} + k_z \tj{+}{n+1/2} \right)& \\
\tB{-}{n+1} =\; & C \tB{-}{n} - 
\frac{S}{\omega}\left(- \frac{ik_\perp }{2} \tE{z}{n} - k_z\tE{-}{n}
\right) + \mu_0 c^2\frac{1-C}{\omega^2} \left( - \frac{ik_\perp }{2}
  \tj{z}{n+1/2} - k_z \tj{-}{n+1/2} \right) &\\
\tB{z}{n+1} =\; & C \tB{z}{n} - 
\frac{S}{\omega}\left(ik_\perp \tE{+}{n} + ik_\perp \tE{-}{n}
\right) + \mu_0 c^2\frac{1-C}{\omega^2} \left( ik_\perp
  \tj{+}{n+1/2} + ik_\perp \tj{-}{n+1/2} \right)&
\end{align*}

\begin{align*}
\tE{+}{n+1} = \; & C \tE{+}{n} + 
\frac{S}{\omega}\left(-\frac{ik_\perp }{2} \tB{z}{n} + k_z\tB{+}{n}
- \mu_0 \tj{+}{n+1/2} \right) + \frac{c^2}{\epsilon_0}
\frac{k_\perp}{2}\left[ \trho{n}\frac{S-\omega\Delta t
  C}{\omega^3\Delta t} + \frac{\trho{n+1}}{\omega^2}\left(
  1 - \frac{S}{\omega\Delta t}\right) \right]  & \\
\tE{-}{n+1} =\; & C \tE{-}{n} +
\frac{S}{\omega}\left(- \frac{ik_\perp }{2} \tB{z}{n} - k_z\tB{-}{n}
- \mu_0 \tj{-}{n+1/2} \right) - \frac{c^2}{\epsilon_0}
\frac{k_\perp}{2}\left[ \trho{n}\frac{S-\omega\Delta t
  C}{\omega^3\Delta t} + \frac{\trho{n+1}}{\omega^2}\left(
  1 - \frac{S}{\omega\Delta t}\right) \right]  &\\
\tE{z}{n+1} =\; & C \tE{z}{n} + 
\frac{S}{\omega}\left(ik_\perp \tB{+}{n} + ik_\perp \tB{-}{n}
- \mu_0 \tj{z}{n+1/2} \right) - \frac{c^2}{\epsilon_0}
ik_z\left[ \trho{n}\frac{S-\omega\Delta t
  C}{\omega^3\Delta t} + \frac{\trho{n+1}}{\omega^2}\left(
  1 - \frac{S}{\omega\Delta t}\right) \right]  &
\end{align*}
where $\omega= c\sqrt{k_z^2 + k_\perp^2}$, $C = \cos(\omega \Delta t)$ and $S = \sin(\omega \Delta t) $. (See \cref{sec:PSTADderiv} for a derivation.)

\newpage
\appendix

\input{appendix.tex}

\bibliography{Bibliography}
\bibliographystyle{plain}

\end{document}  
